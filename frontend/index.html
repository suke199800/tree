<!DOCTYPE html>
<html>
<head>
    <title>포천시 칭찬 나무 지도</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f0f0; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #mapid { flex-grow: 1; height: 100%; }

        #sidebar {
            width: 300px;
            min-width: 300px;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
            position: relative; /* Needed for positioning toggle button absolutely within sidebar */
        }

        #sidebar.hidden {
             transform: translateX(100%);
        }


        #sidebar h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        #schoolSearch {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }


        #schoolList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #schoolList li {
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 1em;
            color: #555;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #schoolList li:last-child {
            border-bottom: none;
        }

        #schoolList li:hover {
            background-color: #f0f0f0;
        }

        #schoolList li strong {
            color: #333;
             flex-grow: 1;
             margin-right: 10px;
        }
         #schoolList li span.stage-info {
             font-size: 0.9em;
             font-weight: bold;
         }
         #schoolList li span.point-stage-info {
             font-size: 0.9em;
             font-weight: bold;
             flex-shrink: 0;
         }


        /* 단계별 색상 (단계 글씨 및 마커 테두리) - 나무 계열 색상 */
        .stage-color-1 { color: #a0522d; border-color: #a0522d; } /* SaddleBrown - 씨앗/흙 */
        .stage-color-2 { color: #8fbc8f; border-color: #8fbc8f; } /* DarkSeaGreen - 새싹 */
        .stage-color-3 { color: #90ee90; border-color: #90ee90; } /* LightGreen - 작은 식물 */
        .stage-color-4 { color: #32cd32; border-color: #32cd32; } /* LimeGreen - 자라는 식물 */
        .stage-color-5 { color: #228b22; border-color: #228b22; } /* ForestGreen - 다 자란 나무 */
        .stage-color-6 { color: #006400; border-color: #006400; } /* DarkGreen - 풍성한 나무 */
        .stage-color-7 { color: #008000; border-color: #008000; } /* Green - 가장 푸른 나무 */


        /* 마커 아이콘 컨테이너 및 이름 표시 스타일 */
        /* .leaflet-marker-pane .leaflet-marker-icon 에서 호버 이벤트 처리 */
        .custom-marker-div:hover .tree-icon-container {
             transform: scale(1.2);
             transition: transform 0.2s ease-in-out;
        }


        .custom-marker-content {
            display: flex;
            flex-direction: column;
            align-items: center;
             width: 60px;
             height: 65px;
        }

        .tree-icon-container {
             width: 40px;
             height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-width: 2px;
            border-style: solid;
            border-radius: 5px;
            overflow: hidden;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.7);
            transition: transform 0.2s ease-in-out;
        }
         .tree-icon-container img {
             display: block;
             width: 100%;
             height: 100%;
             object-fit: contain;
         }

         .school-name-on-map {
             font-size: 0.7em;
             font-weight: bold;
             color: #333;
             text-align: center;
             margin-top: 2px;
             text-shadow: -0.5px -0.5px 0 #fff, 0.5px -0.5px 0 #fff, -0.5px 0.5px 0 #fff, 0.5px 0.5px 0 #fff;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             max-width: 100%;
         }


        /* 사이드바 토글 버튼 스타일 (문손잡이처럼) */
        #sidebarToggleBtn {
            position: absolute; /* Position relative to #sidebar */
            left: 0; /* Position on the left edge of sidebar */
            top: 50%; /* Vertically centered */
            transform: translate(-50%, -50%); /* Shift left by half its width and up by half its height */
            z-index: 1; /* Above sidebar content */
            padding: 12px; /* Size of the button area */
            width: 30px; /* Button visible area width */
            height: 40px; /* Button height */
            background-color: #007aff; /* Apple blue */
            color: white;
            border: none;
            border-top-right-radius: 5px; /* Rounded on the side attached to sidebar */
            border-bottom-right-radius: 5px;
            cursor: pointer;
            font-size: 1.5em; /* Larger font for arrow */
            line-height: 1; /* Vertical alignment */
            box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Shadow on the outside */
            transition: transform 0.3s ease-in-out, background-color 0.2s ease; /* Smooth transition */
            display: flex; /* Use flex for icon centering */
            justify-content: center; /* Center arrow */
            align-items: center; /* Center arrow */
        }

         #sidebar.hidden #sidebarToggleBtn {
             transform: translate(100%, -50%); /* Move right by its full width + half its width, then up by half its height */
             left: 0; /* Stay attached to the left edge of the container */
         }
        /* Adjust icon position/rotation for hidden state */
         #sidebarToggleBtn.rotated {
             transform: translate(100%, -50%) rotateY(180deg); /* Slide out and flip horizontally */
         }
         #sidebarToggleBtn.rotated-initial { /* For initial state if sidebar is hidden */
             transform: translate(100%, -50%); /* Just slide out initially */
         }


        /* Status popup (Tooltip on hover) */
         .school-status-tooltip {
            position: absolute;
            bottom: 100%; /* Position above the marker content */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for centering */
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black background */
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap; /* Prevent wrapping */
            z-index: 1002; /* Above the modal */
            pointer-events: none; /* Ignore mouse events on the tooltip itself */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease-in-out;
         }

         .custom-marker-div:hover .school-status-tooltip {
             opacity: 1; /* Show on hover */
         }
         /* Optional: add a small triangle pointer */
         .school-status-tooltip::after {
             content: '';
             position: absolute;
             top: 100%; /* At the bottom */
             left: 50%; /* Center horizontally */
             transform: translateX(-50%);
             border-width: 5px;
             border-style: solid;
             border-color: rgba(0, 0, 0, 0.7) transparent transparent transparent;
         }


        /* 칭찬 게시판 모달 스타일 */
        #praiseBoardModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #praiseBoardModalContent {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 14px;
            position: relative;
            max-width: 600px;
            width: 90%;
            border: 1px solid #a0522d;
            overflow-y: auto;
            max-height: 90%;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }


        #praiseBoardModal .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            border: none;
            background: none;
            cursor: pointer;
            line-height: 1;
            color: #888;
            transition: color 0.2s ease;
        }
         #praiseBoardModal .close-button:hover {
             color: #333;
         }

        #boardSchoolName {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 600;
        }

        #schoolInfo {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.6;
            color: #555;
             border: 1px solid #ddd;
        }
         #schoolInfo p { margin: 0; }


        #praisePosts {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #a0522d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #fff;
        }

        #praisePosts p {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            color: #444;
        }
        #praisePosts p:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #praisePosts p strong {
             color: #333;
             margin-right: 5px;
        }
         #praisePosts p small {
             display: block;
             font-size: 0.8em;
             color: #999;
             margin-top: 5px;
         }


        #praiseAuthor, #praiseInput {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #a0522d;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }

        #praiseInput {
            height: 100px;
            resize: vertical;
        }

        #submitPraiseButton {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background-color: #228b22;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
         #submitPraiseButton:hover {
             background-color: #006400;
         }
         #submitPraiseButton:disabled {
             background-color: #cccccc;
             cursor: not-allowed;
         }

    </style>
</head>
<body>
    <div id="container">
        <div id="mapid"></div>
        <div id="sidebar">
             <button id="sidebarToggleBtn" onclick="toggleSidebar()">‹</button> <!-- Arrow icon -->
            <h2>포천시 학교/기관</h2>
            <input type="text" id="schoolSearch" placeholder="학교명 검색...">
            <ul id="schoolList">
                <li>로딩 중...</li>
            </ul>
        </div>
    </div>


    <!-- 칭찬 게시판 모달 창 -->
    <div id="praiseBoardModal">
        <div id="praiseBoardModalContent">
            <button class="close-button" onclick="closePraiseBoard()">×</button>
            <h2 id="boardSchoolName"></h2>
            <div id="schoolInfo">
                <p>학교급: <span id="boardSchoolGrade"></span></p>
                <p>현재 나무 단계: <span id="boardTreeStage"></span></p>
                <p>누적 칭찬 포인트: <span id="boardPraisePoints"></span></p>
            </div>

            <hr>

            <h3>칭찬 메시지</h3>
            <div id="praisePosts">
                <p style="text-align: center; color: #888;">칭찬 글을 불러오는 중...</p>
            </div>

            <hr>

            <h3>칭찬 남기기</h3>
            <div>
                <input type="text" id="praiseAuthor" placeholder="작성자 (예: OO초등학교, 익명)">
                <textarea id="praiseInput" placeholder="칭찬 메시지를 입력하세요"></textarea>
                <button id="submitPraiseButton" onclick="submitPraise()">칭찬 보내기</button>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        var map = L.map('mapid').setView([37.95, 127.2], 10.5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);


        let allSchoolMarkers = [];
        let allListItems = [];
        let originalSchoolsData = []; // Stores the original fetched data
        let schoolsAreLoading = false; // Flag to prevent multiple fetch attempts

        // Initialize sidebar button text and position on load
         const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
         const sidebar = document.getElementById('sidebar');
         // Initially, sidebar is visible. Button should indicate "hide".
         sidebarToggleBtn.textContent = '‹'; // Left arrow
         sidebarToggleBtn.classList.remove('rotated', 'rotated-initial');


        loadAndDisplaySchools();


        function loadAndDisplaySchools() {
            if (schoolsAreLoading) {
                console.log("Schools are already loading. Skipping.");
                return; // Prevent duplicate fetches
            }
            schoolsAreLoading = true;

             console.log("Attempting to load and display schools...");

             // Clear existing markers
            allSchoolMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            allSchoolMarkers = [];

             // Clear existing list items
             const schoolListUl = document.getElementById('schoolList');
             schoolListUl.innerHTML = '';
             allListItems = [];

            schoolListUl.innerHTML = '<li>학교 목록 로딩 중...</li>';

            const schoolsApiUrl = '/api/schools';

            console.log(`Fetching schools from: ${schoolsApiUrl}`);

            fetch(schoolsApiUrl)
                .then(response => {
                    console.log(`Schools API response received. Status: ${response.status}`);
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(`HTTP error! status: ${response.status}, body: ${text}`); });
                    }
                    return response.json();
                })
                .then(schools => {
                    console.log(`Successfully fetched ${schools.length} schools.`);
                    originalSchoolsData = schools; // Store original data
                    renderSchoolList(originalSchoolsData); // Render the initial list and markers
                    schoolsAreLoading = false; // Loading finished

                })
                .catch(error => {
                    console.error('학교 데이터를 불러오는 중 오류 발생:', error);
                    alert('학교 데이터를 불러오는데 실패했습니다. 서버 상태를 확인해주세요.');
                    document.getElementById('schoolList').innerHTML = '<li>학교 목록을 불러올 수 없습니다.</li>';
                    schoolsAreLoading = false; // Loading finished
                });
        }


        // Function to render schools on map and list (can be filtered/sorted)
        function renderSchoolList(schoolsToDisplay) {
             console.log(`Rendering ${schoolsToDisplay.length} schools.`);

             // Clear existing markers (if any leftover from previous renders)
             // Note: Markers from original fetch were already cleared by loadAndDisplaySchools
             // If calling renderSchoolList directly (e.g., from search), need to clear ALL markers
             // Let's refine updateAllMarkersDisplay to handle removal/adding for simplicity on refresh
             // But for search/initial load, clearing all markers is fine.
             allSchoolMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            allSchoolMarkers = [];


             const schoolListUl = document.getElementById('schoolList');
             schoolListUl.innerHTML = '';
             allListItems = [];

             if (schoolsToDisplay.length === 0) {
                 schoolListUl.innerHTML = '<li>검색 결과가 없습니다.</li>';
                 // When list is empty, maybe fit view to original bounds?
                 // Handled in fitBounds logic below
                 return;
             }

             schoolsToDisplay.sort((a, b) => {
                 const nameA = a['학교명'].toUpperCase();
                 const nameB = b['학교명'].toUpperCase();
                 if (nameA < nameB) return -1;
                 if (nameA > nameB) return 1;
                 return 0;
             });


            const markerLocations = [];

            schoolsToDisplay.forEach(school => {
                const schoolId = school.id;
                const safeTreeStage = Math.max(1, Math.min(7, school.tree_growth_stage));
                const treeIconUrl = `images/tree_stage_${safeTreeStage}.png`;

                const treeIconHtml = `
                    <div class="custom-marker-content">
                        <div class="tree-icon-container stage-color-${safeTreeStage}">
                            <img src="${treeIconUrl}" alt="${school['학교명']} 나무 단계 ${safeTreeStage}">
                        </div>
                        <span class="school-name-on-map">${school['학교명']}</span>
                        <div class="school-status-tooltip">
                             ${school['학교명']}<br>
                             ${school.praise_points} P<br>
                            <!-- Last post content would require fetching -->
                             마지막 게시글: (불러와야 함)
                        </div>
                    </div>
                `;
                const treeDivIcon = L.divIcon({
                    html: treeIconHtml,
                    className: 'custom-marker-div',
                    iconSize: [60, 65],
                    iconAnchor: [30, 65],
                    popupAnchor: [0, -65]
                });

                var marker = L.marker([school.latitude, school.longitude], { icon: treeDivIcon });

                marker.schoolData = school;

                marker.addTo(map);

                allSchoolMarkers.push(marker);

                markerLocations.push(L.latLng(school.latitude, school.longitude));


                // Add click listener to marker (Open praise board and maybe popup)
                marker.on('click', function(e) {
                    const clickedSchool = e.target.schoolData;
                    console.log('마커 클릭됨:', clickedSchool);
                    // Fly to location on marker click as well, maintaining current zoom
                    const currentZoom = map.getZoom();
                    // Avoid changing zoom unless necessary for clarity on dense areas, maybe only center
                    // map.flyTo([clickedSchool.latitude, clickedSchool.longitude], currentZoom);
                    map.panTo([clickedSchool.latitude, clickedSchool.longitude]); // Just center map

                    openPraiseBoard(clickedSchool); // Open modal

                     // Optional: Open the default popup instead of the custom tooltip
                     // e.target.bindPopup(`<b>${clickedSchool['학교명']}</b>`).openPopup();
                });


                // === Sidebar List Item Creation ===
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${school['학교명']}</strong> <span class="point-stage-info stage-color-${safeTreeStage}">(${school.praise_points}P / ${safeTreeStage}단계)</span>`;
                listItem.schoolData = school;
                listItem.marker = marker;

                // Add click listener to list item
                listItem.addEventListener('click', function() {
                    const clickedSchool = this.schoolData;
                    const clickedMarker = this.marker;
                    console.log('목록 항목 클릭됨:', clickedSchool);

                    // Fly to location on list item click and zoom in
                    map.flyTo([clickedSchool.latitude, clickedSchool.longitude], 15); // Zoom to 15

                    openPraiseBoard(clickedSchool); // Open modal

                    if (clickedMarker) {
                         // Optional: Open the marker's popup when list item is clicked
                        // This is the default Leaflet popup bound earlier (if any)
                        // If using custom divIcon, default bindPopup might not be desired.
                         clickedMarker.openPopup(); // or clickedMarker.bindPopup(...).openPopup();
                    }
                });

                schoolListUl.appendChild(listItem);
                allListItems.push(listItem);

            }); // schoolsToDisplay.forEach End


            // Adjust map view to fit markers or original data bounds
            // Handled here and also after toggleSidebar / invalidateSize
             updateMapViewToBounds(schoolsToDisplay.length > 0 ? L.featureGroup(allSchoolMarkers).getBounds() : null);


            console.log("Finished rendering schools.");

        } // renderSchoolList Function End


        // Function to update map view based on bounds (used by load and toggle)
        function updateMapViewToBounds(bounds) {
            const sidebar = document.getElementById('sidebar');
            const isSidebarHidden = sidebar.classList.contains('hidden');
            const paddingLeft = isSidebarHidden ? 50 : 320; // Adjust padding based on sidebar state
            const paddingRight = 50;
            const paddingTop = 50;
            const paddingBottom = 50;

            if (bounds) {
                 console("Fitting map to bounds...");
                 map.fitBounds(bounds, { paddingTopLeft: [paddingLeft, paddingTop], paddingBottomRight: [paddingRight, paddingBottom], animate: true });
            } else {
                 // If no bounds provided (e.g., empty list after search), fit to the full extent if possible
                 if(originalSchoolsData.length > 0) {
                       // Create bounds from all original schools
                       const allCoords = originalSchoolsData.map(s => L.latLng(s.latitude, s.longitude));
                       const originalBounds = L.latLngBounds(allCoords);
                       console.log("Fitting map to original data bounds...");
                        map.fitBounds(originalBounds, { paddingTopLeft: [paddingLeft, paddingTop], paddingBottomRight: [paddingRight, paddingBottom], animate: true });
                 } else {
                     // If no data at all, set a default view
                     console.log("No school data, setting default map view.");
                     map.setView([37.95, 127.2], 10.5);
                 }
            }
        }


        const schoolSearchInput = document.getElementById('schoolSearch');
        schoolSearchInput.addEventListener('input', function() {
             const searchTerm = this.value.toLowerCase();

             const filteredSchools = originalSchoolsData.filter(school => {
                 return school['학교명'].toLowerCase().includes(searchTerm);
             });

             renderSchoolList(filteredSchools); // Re-render with filtered data
             // updateMapViewToBounds will be called from renderSchoolList
        });


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');

            const isHidden = sidebar.classList.toggle('hidden'); // Toggle the 'hidden' class and get its state

            if (isHidden) {
                 sidebarToggleBtn.textContent = '›'; // Right arrow (shows sidebar)
                 sidebarToggleBtn.classList.add('rotated'); // Rotate for transition
             } else {
                 sidebarToggleBtn.textContent = '‹'; // Left arrow (hides sidebar)
                 sidebarToggleBtn.classList.remove('rotated'); // Remove rotation
             }

             // Invalidate map size and re-fit bounds after transition
             setTimeout(() => {
                 map.invalidateSize(true);
                 // Recalculate bounds based on *current* visible markers (if any are visible)
                 // Pass the bounds of markers currently added to the map
                 const currentVisibleMarkers = allSchoolMarkers.filter(marker => map.hasLayer(marker));
                  if(currentVisibleMarkers.length > 0) {
                       const currentBounds = L.featureGroup(currentVisibleMarkers).getBounds();
                       updateMapViewToBounds(currentBounds); // Fit to visible markers
                  } else {
                      // If no markers are currently visible on the map, fit to original data bounds
                      // This handles the case where search resulted in no matches before hiding sidebar
                      updateMapViewToBounds(null); // Fit to original data bounds (if any) or default view
                  }

             }, 350); // Match CSS transition duration (0.3s) + small buffer
        }


        // Function to open praise board modal
        function openPraiseBoard(school) {
            console.log(`${school['학교명']} (ID: ${school.id}) 칭찬 릴레이 게시판 열기`);

            const modal = document.getElementById('praiseBoardModal');
            const boardSchoolName = document.getElementById('boardSchoolName');
            const boardSchoolGrade = document.getElementById('boardSchoolGrade');
            const boardTreeStage = document.getElementById('boardTreeStage');
            const boardPraisePoints = document.getElementById('boardPraisePoints');
            const praisePostsDiv = document.getElementById('praisePosts');
            const praiseAuthorInput = document.getElementById('praiseAuthor');
            const praiseInput = document.getElementById('praiseInput');
            const submitButton = document.getElementById('submitPraiseButton');

            boardSchoolName.textContent = school['학교명'];
            boardSchoolGrade.textContent = school['학교급구분'];
            boardTreeStage.textContent = school.tree_growth_stage;
            boardPraisePoints.textContent = school.praise_points;

            modal.currentSchool = school;

            praisePostsDiv.innerHTML = '<p style="text-align: center; color: #888;">칭찬 글을 불러오는 중...</p>';

            loadPraisePosts(school.id);

            modal.style.display = 'flex';
        }

        // Function to close praise board modal
        function closePraiseBoard() {
            const modal = document.getElementById('praiseBoardModal');
            modal.style.display = 'none';

            document.getElementById('praiseAuthor').value = '';
            document.getElementById('praiseInput').value = '';
            delete modal.currentSchool;
        }

        // Close modal when clicking outside the content
        const praiseBoardModal = document.getElementById('praiseBoardModal');
        praiseBoardModal.addEventListener('click', function(event) {
            if (event.target === praiseBoardModal) {
                closePraiseBoard();
            }
        });


        // Function to load and display praise posts for a school
        function loadPraisePosts(schoolId) {
            console.log(`Fetching praise posts for school ID: ${schoolId}`);
            const praisePostsDiv = document.getElementById('praisePosts');
            praisePostsDiv.innerHTML = '<p style="text-align: center; color: #888;">칭찬 글을 불러오는 중...</p>';

            const postsApiUrl = `/api/schools/${schoolId}/posts`;

            fetch(postsApiUrl)
            .then(response => {
                console.log(`Posts API response status for school ${schoolId}: ${response.status}`);
                 if (!response.ok) {
                      return response.text().then(text => { throw new Error(`HTTP error! status: ${response.status}, body: ${text}`); });
                 }
                 return response.json();
            })
            .then(posts => {
                console.log(`Successfully fetched ${posts.length} praise posts for school ID: ${schoolId}`);
                praisePostsDiv.innerHTML = '';

                if (posts.length === 0) {
                    praisePostsDiv.innerHTML = '<p style="text-align: center; color: #555;">아직 칭찬 메시지가 없습니다.</p>';
                    return;
                }

                posts.forEach(post => {
                    const postElement = document.createElement('p');
                     const authorInfo = post.author_info ? `<strong>${post.author_info}:</strong> ` : '';
                     const postTime = new Date(post.created_at).toLocaleString();
                    postElement.innerHTML = `${authorInfo}${post.content}<br><small>${postTime}</small>`;
                    praisePostsDiv.appendChild(postElement);
                });
            })
            .catch(error => {
                console.error(`칭찬 글 목록 로드 중 오류 발생 (학교 ID: ${schoolId}):`, error);
                praisePostsDiv.innerHTML = '<p style="text-align: center; color: red;">칭찬 글을 불러올 수 없습니다. (오류 상세 정보는 브라우저 콘솔 확인)</p>';
            });
        }


        // Function to submit a new praise post
        function submitPraise() {
            const modal = document.getElementById('praiseBoardModal');
            const school = modal.currentSchool;

            if (!school || !school.id) {
                alert('오류: 학교 정보가 없습니다.');
                return;
            }

            const schoolId = school.id;
            const author = document.getElementById('praiseAuthor').value.trim();
            const content = document.getElementById('praiseInput').value.trim();

            if (!content) {
                alert('칭찬 메시지를 입력해주세요.');
                return;
            }

            console.log(`Attempting to submit praise for school ID ${schoolId}: "${content}" by ${author || '익명'}`);

            const submitButton = document.getElementById('submitPraiseButton');
            submitButton.disabled = true;
            submitButton.textContent = '전송 중...';

            const submitApiUrl = `/api/schools/${schoolId}/posts`;

            fetch(submitApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content, author: author })
            })
            .then(response => {
                console.log(`Submit praise API response status for school ${schoolId}: ${response.status}`);
                 if (!response.ok) {
                      return response.text().then(text => { throw new Error(`HTTP error! status: ${response.status}, body: ${text}`); });
                 }
                 return response.json();
            })
            .then(result => {
                console.log('칭찬 등록 결과:', result);
                alert('칭찬이 전달되었습니다!');
                document.getElementById('praiseAuthor').value = '';
                document.getElementById('praiseInput').value = '';

                loadPraisePosts(schoolId); // Refresh praise post list

                 // Update modal info with new points and stage
                 document.getElementById('boardTreeStage').textContent = result.new_stage;
                 document.getElementById('boardPraisePoints').textContent = result.new_points;

                // Update markers display and list item display for the specific school
                // Update only the specific school's marker and list item
                updateSchoolDisplay(result.updated_school);


            })
            .catch(error => {
                console.error('칭찬 등록 중 오류 발생:', error);
                alert('칭찬 등록에 실패했습니다.');
            })
            .finally(() => {
                 submitButton.disabled = false;
                 submitButton.textContent = '칭찬 보내기';
            });
        }

         // Function to update marker and list item display for a specific school
         // Called after a praise post is successfully submitted
         function updateSchoolDisplay(updatedSchool) {
             console.log(`Updating display for school ID: ${updatedSchool.id}`);

             // Find the marker for the updated school
             const markerToUpdate = allSchoolMarkers.find(marker => marker.schoolData.id === updatedSchool.id);

             if (markerToUpdate) {
                 // Update the school data linked to the marker
                 markerToUpdate.schoolData = updatedSchool;

                 // Update the marker icon based on the new stage
                 const safeTreeStage = Math.max(1, Math.min(7, updatedSchool.tree_growth_stage));
                 const treeIconUrl = `images/tree_stage_${safeTreeStage}.png`;

                 const treeIconHtml = `
                     <div class="custom-marker-content">
                         <div class="tree-icon-container stage-color-${safeTreeStage}">
                             <img src="${treeIconUrl}" alt="${updatedSchool['학교명']} 나무 단계 ${safeTreeStage}">
                         </div>
                         <span class="school-name-on-map">${updatedSchool['학교명']}</span>
                         <div class="school-status-tooltip">
                              ${updatedSchool['학교명']}<br>
                              ${updatedSchool.praise_points} P<br>
                              <!-- Last post content would require fetching -->
                              마지막 게시글: (불러와야 함)
                         </div>
                     </div>
                 `;
                 const newTreeDivIcon = L.divIcon({
                     html: treeIconHtml,
                     className: 'custom-marker-div',
                     iconSize: [60, 65],
                     iconAnchor: [30, 65],
                     popupAnchor: [0, -65]
                 });

                 markerToUpdate.setIcon(newTreeDivIcon); // Set the new icon

                 // Find the list item for the updated school and update its display
                 const listItemToUpdate = allListItems.find(item => item.schoolData.id === updatedSchool.id);
                  if(listItemToUpdate) {
                      const safeUpdatedStage = Math.max(1, Math.min(7, updatedSchool.tree_growth_stage));
                       // Update innerHTML to show new points and stage
                      listItemToUpdate.innerHTML = `<strong>${updatedSchool['학교명']}</strong> <span class="point-stage-info stage-color-${safeUpdatedStage}">(${updatedSchool.praise_points}P / ${safeUpdatedStage}단계)</span>`;
                       // Update the stage color class on the list item span
                       const stageInfoSpan = listItemToUpdate.querySelector('.point-stage-info');
                       stageInfoSpan.className = `point-stage-info stage-color-${safeUpdatedStage}`;
                  }

                 console.log(`Marker and list item updated for school ID: ${updatedSchool.id}`);

             } else {
                  console.warn(`Marker not found for updated school ID: ${updatedSchool.id}. This should not happen if allSchoolMarkers and allListItems are correctly managed.`);
             }
         }

         // Initial state check for sidebar button text
         if (sidebar.classList.contains('hidden')) {
              sidebarToggleBtn.textContent = '›'; // Right arrow if initially hidden
              sidebarToggleBtn.classList.add('rotated-initial'); // Add initial rotation class for CSS
         } else {
              sidebarToggleBtn.textContent = '‹'; // Left arrow if initially visible
         }


    </script>
</body>
</html>
