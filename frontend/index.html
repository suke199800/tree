<!DOCTYPE html>
<html>
<head>
    <title>포천시 칭찬 나무 지도</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <!-- Google Maps JavaScript API 로드 (발급받은 API 키 필요!) -->
    <!-- YOUR_API_KEY 부분을 발급받은 Google Maps API 키로 변경하세요. -->
    <!-- 데이터가 WGS84 좌표임을 확인했으므로 pyproj 변환은 제거했고,
         OpenStreetMap 대신 Google Maps 타일을 사용하려면 API 키 필요. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
    <!-- Leaflet.GoogleMutant 플러그인 로드 (Google Maps 타일 사용 시 필요) -->
    <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.x.x/Leaflet.GoogleMutant.js"></script>


    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f0f0; }
        #container { display: flex; height: 100vh; }
        #mapid { flex-grow: 1; height: 100%; }

        /* 사이드바 스타일 */
        #sidebar {
            width: 300px;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        #sidebar h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        #schoolList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #schoolList li {
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 1em;
            color: #555;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #schoolList li:last-child {
            border-bottom: none;
        }

        #schoolList li:hover {
            background-color: #f0f0f0;
        }

        #schoolList li strong {
            color: #333;
             flex-grow: 1;
             margin-right: 10px;
        }
         #schoolList li span.stage-info {
             font-size: 0.9em;
             font-weight: bold;
         }

        /* 단계별 색상 (단계 글씨 및 마커 테두리) - 나무 계열 색상 */
        .stage-color-1 { color: #a0522d; border-color: #a0522d; } /* SaddleBrown - 씨앗/흙 */
        .stage-color-2 { color: #8fbc8f; border-color: #8fbc8f; } /* DarkSeaGreen - 새싹 */
        .stage-color-3 { color: #90ee90; border-color: #90ee90; } /* LightGreen - 작은 식물 */
        .stage-color-4 { color: #32cd32; border-color: #32cd32; } /* LimeGreen - 자라는 식물 */
        .stage-color-5 { color: #228b22; border-color: #228b22; } /* ForestGreen - 다 자란 나무 */
        .stage-color-6 { color: #006400; border-color: #006400; } /* DarkGreen - 풍성한 나무 */
        .stage-color-7 { color: #008000; border-color: #008000; } /* Green - 가장 푸른 나무 */


        /* 마커 아이콘 컨테이너 및 이름 표시 스타일 */
        .custom-marker-content {
            display: flex;
            flex-direction: column;
            align-items: center;
             width: 60px;
             height: 65px;
        }

        .tree-icon-container {
             width: 40px;
             height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-width: 2px;
            border-style: solid;
            border-radius: 5px;
            overflow: hidden;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.7);
        }
         .tree-icon-container img {
             display: block;
             width: 100%;
             height: 100%;
             object-fit: contain;
         }

         .school-name-on-map {
             font-size: 0.7em;
             font-weight: bold;
             color: #333;
             text-align: center;
             margin-top: 2px;
             text-shadow: -0.5px -0.5px 0 #fff, 0.5px -0.5px 0 #fff, -0.5px 0.5px 0 #fff, 0.5px 0.5px 0 #fff;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             max-width: 100%;
         }


        /* 칭찬 게시판 모달 스타일 */
        #praiseBoardModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #praiseBoardModalContent {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 14px;
            position: relative;
            max-width: 600px;
            width: 90%;
            border: 1px solid #a0522d;
            overflow-y: auto;
            max-height: 90%;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }


        #praiseBoardModal .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            border: none;
            background: none;
            cursor: pointer;
            line-height: 1;
            color: #888;
            transition: color 0.2s ease;
        }
         #praiseBoardModal .close-button:hover {
             color: #333;
         }

        #boardSchoolName {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 600;
        }

        #schoolInfo {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.6;
            color: #555;
             border: 1px solid #ddd;
        }
         #schoolInfo p { margin: 0; }


        #praisePosts {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #a0522d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #fff;
        }

        #praisePosts p {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            color: #444;
        }
        #praisePosts p:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #praisePosts p strong {
             color: #333; /* 작성자 이름 색상 */
             margin-right: 5px;
        }
         #praisePosts p small {
             display: block; /* 날짜/시간을 다음 줄에 표시 */
             font-size: 0.8em;
             color: #999;
             margin-top: 5px;
         }


        #praiseAuthor, #praiseInput {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #a0522d;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }

        #praiseInput {
            height: 100px;
            resize: vertical;
        }

        #submitPraiseButton {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background-color: #228b22;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
         #submitPraiseButton:hover {
             background-color: #006400;
         }
         #submitPraiseButton:disabled {
             background-color: #cccccc;
             cursor: not-allowed;
         }


    </style>
</head>
<body>
    <div id="container">
        <div id="mapid"></div>
        <div id="sidebar">
            <h2>포천시 학교/기관</h2>
            <ul id="schoolList">
                <!-- 학교 목록이 여기에 로드될 예정 -->
                <li>로딩 중...</li>
            </ul>
        </div>
    </div>


    <!-- 칭찬 게시판 모달 창 -->
    <div id="praiseBoardModal">
        <div id="praiseBoardModalContent">
            <button class="close-button" onclick="closePraiseBoard()">×</button>
            <h2 id="boardSchoolName"></h2>
            <div id="schoolInfo">
                <p>학교급: <span id="boardSchoolGrade"></span></p>
                <p>현재 나무 단계: <span id="boardTreeStage"></span></p>
                <p>누적 칭찬 포인트: <span id="boardPraisePoints"></span></p>
            </div>

            <hr>

            <h3>칭찬 메시지</h3>
            <div id="praisePosts">
                <!-- 여기에 칭찬 글 목록이 로드될 예정 -->
                <p style="text-align: center; color: #888;">칭찬 글을 불러오는 중...</p>
            </div>

            <hr>

            <h3>칭찬 남기기</h3>
            <div>
                <input type="text" id="praiseAuthor" placeholder="작성자 (예: OO초등학교, 익명)">
                <textarea id="praiseInput" placeholder="칭찬 메시지를 입력하세요"></textarea>
                <button id="submitPraiseButton" onclick="submitPraise()">칭찬 보내기</button>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet.GoogleMutant 플러그인 스크립트 (Google Maps 타일 사용 시 필요) -->
    <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.x.x/Leaflet.GoogleMutant.js"></script>


    <script>
        // 초기 지도 설정 (fitBounds로 자동 조정될 예정)
        var map = L.map('mapid');

        // Google Maps 타일 레이어 사용 (API 키 필요!)
        // YOUR_API_KEY를 실제 발급받은 Google Maps API 키로 변경해야 합니다.
        var googleLayer = L.gridLayer.googleMutant({
            type: 'roadmap' // 'roadmap', 'satellite', 'hybrid', 'terrain' 등 사용 가능
        }).addTo(map);


        // 백엔드에서 학교 데이터를 가져와 마커 표시 및 목록 채우기
        let allSchoolMarkers = []; // 모든 마커 객체를 저장할 배열 (갱신 시 사용)
        let allListItems = []; // 모든 목록 항목 객체를 저장할 배열 (갱신 시 사용)

        function loadAndDisplaySchools() {
             // 기존 마커 제거
            allSchoolMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            allSchoolMarkers = []; // 배열 비우기

            // 기존 목록 항목 제거
             const schoolListUl = document.getElementById('schoolList');
             schoolListUl.innerHTML = '';
             allListItems = []; // 배열 비우기

            schoolListUl.innerHTML = '<li>학교 목록 로딩 중...</li>'; // 로딩 표시

            fetch('http://127.0.0.0:5000/api/schools') // 로컬 테스트 주소
            // Render 배포 시에는 Render 서비스 URL의 /api/schools 로 변경해야 함
            // 예: fetch('/api/schools') 또는 fetch('https://your-render-service.onrender.com/api/schools')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(schools => {
                    schoolListUl.innerHTML = ''; // 로딩 중 메시지 제거

                    const markerLocations = []; // 모든 마커의 위치를 저장할 배열

                    schools.forEach(school => {
                        // 학교의 고유 ID를 사용합니다. (DB 사용 시 school.id가 정확한 ID가 됩니다.)
                        // 현재 JSON 파일 기반에서는 임시 ID (1부터 시작)가 부여됩니다.
                        const schoolId = school.id;

                        // 나무 단계(1~7)에 맞는 이미지 파일 경로 생성
                        const treeIconUrl = `images/tree_stage_${school.tree_growth_stage}.png`;

                        // 커스텀 HTML 아이콘 생성 (이미지 + 이름, 단계별 색상 클래스 추가)
                        const treeIconHtml = `
                            <div class="custom-marker-content">
                                <div class="tree-icon-container stage-color-${school.tree_growth_stage}">
                                    <img src="${treeIconUrl}" alt="${school['학교명']} 나무 단계 ${school.tree_growth_stage}">
                                </div>
                                <span class="school-name-on-map">${school['학교명']}</span>
                            </div>
                        `;
                        const treeDivIcon = L.divIcon({
                            html: treeIconHtml,
                            className: 'custom-marker-div',
                            iconSize: [60, 65],
                            iconAnchor: [30, 65],
                            popupAnchor: [0, -65]
                        });

                        // 커스텀 아이콘을 사용하여 마커 생성
                        var marker = L.marker([school.latitude, school.longitude], { icon: treeDivIcon });

                        // 마커에 데이터 연결
                        marker.schoolData = school;

                        // 마커를 지도에 추가
                        marker.addTo(map);

                        // 마커 객체를 배열에 저장
                        allSchoolMarkers.push(marker);

                        // 모든 마커의 위치를 배열에 추가 (fitBounds용)
                        markerLocations.push(L.latLng(school.latitude, school.longitude));


                        // === 사이드바 목록 항목 생성 ===
                        const listItem = document.createElement('li');
                        // 목록 항목에 단계별 색상 클래스 추가
                        listItem.innerHTML = `<strong>${school['학교명']}</strong> <span class="stage-info stage-color-${school.tree_growth_stage}">(${school.tree_growth_stage}단계)</span>`;
                        listItem.schoolData = school; // 목록 항목에도 학교 데이터 연결
                        listItem.marker = marker; // 목록 항목에 해당 마커 객체 연결

                        // 목록 항목 클릭 이벤트 리스너 추가
                        listItem.addEventListener('click', function() {
                             const clickedSchool = this.schoolData;
                             const clickedMarker = this.marker;
                             console.log('목록 항목 클릭됨:', clickedSchool);

                             // 지도 이동 및 줌 레벨 변경
                             // 현재 줌 레벨을 기준으로 줌 레벨 15 또는 현재 줌 + 4 (최대 18)로 확대 이동
                             const currentZoom = map.getZoom();
                             const targetZoom = Math.min(currentZoom + 4, 18); // 최대 18
                             map.flyTo([clickedSchool.latitude, clickedSchool.longitude], targetZoom);

                             openPraiseBoard(clickedSchool);

                             if (clickedMarker) {
                                 clickedMarker.openPopup();
                             }
                        });

                        // 목록에 항목 추가
                        schoolListUl.appendChild(listItem);
                        // 목록 항목 객체를 배열에 저장
                        allListItems.push(listItem);

                    }); // schools.forEach 끝

                    // 모든 마커의 위치를 포함하는 Bounding Box 계산 및 지도 뷰 설정
                    if (markerLocations.length > 0) {
                        const bounds = L.latLngBounds(markerLocations);
                        // 모든 마커가 화면에 들어오도록 지도 뷰를 조정합니다.
                        // padding 옵션을 사용하여 마커가 화면 가장자리에 붙지 않도록 여백을 줍니다.
                        // 사이드바 너비만큼 왼쪽 여백을 더 줄 수 있습니다.
                        map.fitBounds(bounds, { padding: [50, 50] }); // 상하좌우 50px 여백 예시
                         // 만약 사이드바가 고정 너비라면, paddingLeft 옵션 등으로 왼쪽 여백을 추가 고려
                         // map.fitBounds(bounds, { paddingTopLeft: [320, 50], paddingBottomRight: [50, 50] }); // 예시 (사이드바 너비 300px + 여백 20px)
                    } else {
                        // 학교 데이터가 없을 경우 기본 뷰 설정
                        map.setView([37.95, 127.2], 11);
                    }

                }) // fetch .then(schools => ...) 끝
                .catch(error => {
                    console.error('학교 데이터를 불러오는 중 오류 발생:', error);
                    alert('학교 데이터를 불러오는데 실패했습니다. 서버 상태를 확인해주세요.');
                    document.getElementById('schoolList').innerHTML = '<li>학교 목록을 불러올 수 없습니다.</li>';
                });
        } // loadAndDisplaySchools 함수 끝

        // 페이지 로드 시 학교 데이터 로드 및 표시 함수 호출
        loadAndDisplaySchools();


        // 칭찬 게시판을 여는 함수
        function openPraiseBoard(school) {
            console.log(`${school['학교명']} (ID: ${school.id}) 칭찬 릴레이 게시판 열기`);

            const modal = document.getElementById('praiseBoardModal');
            const boardSchoolName = document.getElementById('boardSchoolName');
            const boardSchoolGrade = document.getElementById('boardSchoolGrade');
            const boardTreeStage = document.getElementById('boardTreeStage');
            const boardPraisePoints = document.getElementById('boardPraisePoints');
            const praisePostsDiv = document.getElementById('praisePosts');
             const praiseAuthorInput = document.getElementById('praiseAuthor');
             const praiseInput = document.getElementById('praiseInput');
             const submitButton = document.getElementById('submitPraiseButton');

            // 학교 정보 업데이트
            boardSchoolName.textContent = school['학교명'];
            boardSchoolGrade.textContent = school['학교급구분'];
            boardTreeStage.textContent = school.tree_growth_stage;
            boardPraisePoints.textContent = school.praise_points;

            // 현재 열린 학교 정보 저장 (글 작성 시 필요)
             modal.currentSchool = school;

            // 칭찬 글 목록 초기화 및 로딩 메시지 표시
            praisePostsDiv.innerHTML = '<p style="text-align: center; color: #888;">칭찬 글을 불러오는 중...</p>';

            // TODO: 해당 학교의 칭찬 글 목록을 백엔드에서 가져와 표시하는 함수 호출
            loadPraisePosts(school.id); // 학교 ID를 인자로 전달

            // 모달 보이기
            modal.style.display = 'flex';
        }

        // 칭찬 게시판을 닫는 함수
        function closePraiseBoard() {
            const modal = document.getElementById('praiseBoardModal');
            modal.style.display = 'none';

            // 모달 닫을 때 입력 필드 초기화 및 저장된 학교 정보 삭제
            document.getElementById('praiseAuthor').value = '';
            document.getElementById('praiseInput').value = '';
             delete modal.currentSchool;
        }

        // 특정 학교의 칭찬 글 목록을 불러와 표시하는 함수 구현
        function loadPraisePosts(schoolId) {
            console.log(`학교 ID ${schoolId}의 칭찬 글 목록 불러오기`);
            const praisePostsDiv = document.getElementById('praisePosts');
            praisePostsDiv.innerHTML = '<p style="text-align: center; color: #888;">칭찬 글을 불러오는 중...</p>';

            // 백엔드 API 호출 (칭찬 글 목록 조회)
            fetch(`http://127.0.0.1:5000/api/schools/${schoolId}/posts`) // 로컬 테스트 주소
            // Render 배포 시에는 Render 서비스 URL의 /api/schools/ID/posts 로 변경해야 함
            // 예: fetch(\`\${window.location.origin}/api/schools/\${schoolId}/posts\`)
            .then(response => {
                 if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                 return response.json();
            })
            .then(posts => {
                praisePostsDiv.innerHTML = ''; // 로딩 메시지 제거

                if (posts.length === 0) {
                    praisePostsDiv.innerHTML = '<p style="text-align: center; color: #555;">아직 칭찬 메시지가 없습니다.</p>';
                    return;
                }

                // 칭찬 글 목록을 HTML로 만들어 표시
                posts.forEach(post => {
                    const postElement = document.createElement('p');
                     const authorInfo = post.author_info ? `<strong>${post.author_info}:</strong> ` : '';
                     // created_at이 ISO 문자열 형태라고 가정하고 Date 객체로 파싱
                     const postTime = new Date(post.created_at).toLocaleString();
                    postElement.innerHTML = `${authorInfo}${post.content}<br><small>${postTime}</small>`;
                    praisePostsDiv.appendChild(postElement);
                });
            })
            .catch(error => {
                console.error(`칭찬 글 목록 로드 중 오류 발생 (학교 ID: ${schoolId}):`, error);
                praisePostsDiv.innerHTML = '<p style="text-align: center; color: red;">칭찬 글을 불러올 수 없습니다.</p>';
            });
        }


        // 칭찬 글 작성 제출 함수
        function submitPraise() {
            const modal = document.getElementById('praiseBoardModal');
            const school = modal.currentSchool;

            if (!school || !school.id) {
                alert('오류: 학교 정보가 없습니다.');
                return;
            }

            const schoolId = school.id;
            const author = document.getElementById('praiseAuthor').value.trim();
            const content = document.getElementById('praiseInput').value.trim();

            if (!content) {
                alert('칭찬 메시지를 입력해주세요.');
                return;
            }

            console.log(`학교 ID ${schoolId}에 칭찬 보내기 시도: "${content}" by ${author || '익명'}`);

            const submitButton = document.getElementById('submitPraiseButton');
            submitButton.disabled = true; // 버튼 비활성화
            submitButton.textContent = '전송 중...';

            // 백엔드 API 호출 (칭찬 글 작성)
            fetch(`http://127.0.0.1:5000/api/schools/${schoolId}/posts`, { // 로컬 테스트 주소
            // Render 배포 시에는 Render 서비스 URL의 /api/schools/ID/posts 로 변경해야 함
            // 예: fetch(\`\${window.location.origin}/api/schools/\${schoolId}/posts\`, { ... })
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content, author: author })
            })
            .then(response => {
                 // 201 Created 상태 코드를 포함한 성공 응답 확인
                 if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                 return response.json();
            })
            .then(result => {
                console.log('칭찬 등록 결과:', result);
                alert('칭찬이 전달되었습니다!');
                // 입력 필드 초기화
                document.getElementById('praiseAuthor').value = '';
                document.getElementById('praiseInput').value = '';

                // 칭찬 글 목록 새로고침
                loadPraisePosts(schoolId);

                // 업데이트된 학교 정보로 모달 내 정보 업데이트
                 document.getElementById('boardTreeStage').textContent = result.new_stage;
                 document.getElementById('boardPraisePoints').textContent = result.new_points;

                // TODO: 지도 마커 업데이트 (단계 변경 반영)
                // loadAndDisplaySchools(); // 전체 학교 데이터를 다시 불러와 마커를 새로 그리는 방식

            })
            .catch(error => {
                console.error('칭찬 등록 중 오류 발생:', error);
                alert('칭찬 등록에 실패했습니다.');
            })
            .finally(() => {
                 // 전송 성공/실패 여부와 관계없이 버튼 다시 활성화
                 submitButton.disabled = false;
                 submitButton.textContent = '칭찬 보내기';
            });
        }

         // TODO: 칭찬 글 작성 성공 시 지도 마커 갱신 로직 구현
         // updateAllMarkers 함수 대신 loadAndDisplaySchools 함수를 다시 호출하는 방식 사용
         // loadAndDisplaySchools 함수는 기존 마커를 지우고 새 데이터를 불러와 다시 그립니다.
         // submitPraise 성공 시 .then 블록 안에서 호출합니다.
         // 예: loadAndDisplaySchools();

    </script>
</body>
</html>
